<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/geo-location/geo-location.html">

<dom-module id="my-view1">

  <template>

    <style>
      :host {
        display: block;
        padding: 10px;
      }
      .card {
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        padding: 16px;
        margin: 24px;
        border-radius: 5px;
        background-color: #fff;
        color: #757575;
      }
      .circle {
        display: inline-block;
        height: 64px;
        width: 64px;
        border-radius: 50%;
        background: #ddd;
        line-height: 64px;
        font-size: 30px;
        color: #555;
        text-align: center;
      }
      h1 {
        font-size: 22px;
        margin: 16px 0;
        color: #212121;
      }
      google-map {
        height: 600px;
      }
    </style>
    
    <!--<firebase-query
        id="query"
        path="/fleets"
        data="{{fleets}}">
    </firebase-query>-->

    <!--<app-indexeddb-mirror id="updatesFleets"
      key="/fleets"
      data="[[fleets]]"
      persisted-data="{{activeFleets}}"
      >
    </app-indexeddb-mirror>-->

    <div class="card">
      <geo-location latitude="{{currentLat}}" longitude="{{currentLng}}"></geo-location>
      <google-map latitude="[[currentLat]]" longitude="[[currentLng]]" map="{{map}}"  api-key="AIzaSyCl1xcLoRekaS0BZljwkv2fWdX4RzcBqn0">
        <template is="dom-repeat" items="[[persistedData]]" as="fleet">
          <google-map-marker map="[[map]]" latitude="[[fleet.latitude]]" longitude="[[fleet.longitude]]" title="[[fleet.name]]" draggable="true"></google-map-marker>
        </template>
      </google-map>
    </div>

  </template>

  <script>

    Polymer({

      is: 'my-view1',
      properties: {
        fleets: {
          type: Array,
          // observer: '_fleetsChanged',
          notify: true
        },
        map: Object,
        persistedData: Array,
        activeFleets: {
          type: Array,
          notify: true
        }
      },
      // observers: ['_fleetsChanged(fleets.splices)'],
      ready: function() {
       // console.log('Indexed db', this.$.updatesFleets.getStoredValue('/fleets'));
        // setTimeout(function() {

        //   this.fleets =  [{"name":"Denise","latitude":49.83383,"longitude":19.9383},
        //         {"name":"Helen","latitude":33.29565,"longitude":61.95221},
        //         {"name":"Beverly","latitude":53.45198,"longitude":17.53169},
        //         {"name":"Roy","latitude":-4.06253,"longitude":144.06609},
        //         {"name":"Julie","latitude":59.8254,"longitude":10.8512},
        //         {"name":"Sean","latitude":46.42476,longitude:33.14721},
        //         {"name":"Clarence","latitude":6.69903,"longitude":-72.73233},
        //         {"name":"Peter","latitude":-7.13972,"longitude":110.405},
        //         {"name":"Irene","latitude":-7.0069,"longitude":108.4708},
        //         {"name":"Virginia","latitude":56.12128,"longitude":101.17767}];
        // }.bind(this), 3000);

        var ref = firebase.database().ref('fleets');
        ref.on('value', function(snapshot) {
          this.fleets = this._toArray(snapshot.val());
        
          this.fleets = this.fleets.map(function(fleet) {
            return {
              name: fleet.name,
              latitude: +fleet.latitude,
              longitude: +fleet.longitude
            }
          })
         
           getIDBData().then(function(data){           
           this.persistedData = data;
            console.log(this.persistedData);           
          }.bind(this));
          addData(this.fleets);
         
        }.bind(this));
      },
      // _fleetsChanged: function(newVal) {
      //   // console.log('Old Value', oldVal);
      //   console.log('New Value', newVal);
      //  // cache.put('fleets', newVal);
      // //  this.persistedFleets = cache.get('fleets');
      //   // this.fleets = newVal;
      // },
      _toArray: function(obj) {
            return Object.keys(obj).map(function(key) {
                return obj[key];
            });
        },


  
    

    });

  </script>

</dom-module>
